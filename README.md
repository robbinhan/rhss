# RHSS - Rust Hybrid Storage System

一个基于 FUSE 的混合存储文件系统，支持根据文件大小自动分配到热存储（SSD）或冷存储（HDD）。

## 功能特性

- ✅ **安全退出机制**：支持多种信号（Ctrl+C, SIGTERM, SIGHUP），优雅关闭并清理资源
- 🔄 基于文件大小阈值的自动存储分层
- 🚀 支持 Tokio 和 Rustix 两种存储后端
- 📁 FUSE 文件系统接口，透明访问

## TODO
- [x] 安全退出程序
  - 支持多种终止信号（Ctrl+C, SIGTERM, SIGHUP）
  - 优雅关闭文件句柄和清理资源
  - 超时机制防止挂起
  - 详细的退出日志和错误处理
- [x] benchmark测试（fuse和posix两种）
  - 完整的性能基准测试套件
  - 支持 Tokio 和 Rustix 两种存储后端
  - 测试小文件和大文件的读写性能
  - 自动对比两种后端的性能差异
  - 彩色输出显示性能对比结果
- [x] 程序启动后应该给hot和cold存储加锁，不允许其他程序访问
  - 实现了基于文件的锁机制
  - 锁文件包含进程PID、主机名、创建时间等信息
  - 自动检测并清理过期锁（进程已退出）
  - 支持 --force 参数强制获取锁
  - 程序退出时自动释放锁
  - **文件系统级别权限控制（方案一）**
    - 获取锁时自动将存储目录权限设置为 700（仅所有者可访问）
    - 防止其他用户/进程直接访问存储目录
    - 程序退出时自动恢复原始权限
  - **隐藏存储模式（方案三）**
    - 使用 --hidden-storage 参数启用
    - 将实际存储移到系统临时目录的隐藏位置
    - 原始目录设为只读，防止直接访问
    - 所有操作只能通过 FUSE 挂载点进行
    - 程序退出时自动同步内容回原始位置并清理隐藏目录
- [x] 添加文件位置缓存：记录每个文件实际所在的存储层，避免每次都要尝试两个存储
  - 实现了高性能的内存缓存机制
  - TTL（生存时间）：5分钟，自动过期清理
  - 最大容量：10000个条目，LRU淘汰策略
  - 缓存命中时直接从已知位置读取，避免搜索
  - 支持批量更新（目录列表时）
  - 文件操作时自动更新缓存（写入、删除）
  - 缓存统计信息：可查看命中率和分布情况
- [x] 文件迁移机制：当检测到文件位置与阈值规则不符时，自动迁移文件到正确的存储层
  - 自动检测文件位置是否符合大小阈值规则
  - 支持单文件迁移和批量目录迁移
  - 写入文件时自动迁移到正确存储层
  - 提供独立的迁移工具 (`cargo run --bin migrate`)
  - 迁移后自动更新缓存位置信息
  - 支持全存储扫描和修正

## 测试

### 运行安全退出测试
```bash
./test_shutdown.sh
```

### 测试存储锁和权限控制
```bash
# 测试基本锁机制
./test_lock.sh

# 测试权限控制功能（方案一）
./test_permissions.sh

# 测试隐藏存储模式（方案三）
./test_hidden_storage.sh

# 测试文件位置缓存
./test_cache.sh

# 测试文件迁移机制
./test_migration.sh
```

### 运行性能基准测试
```bash
# 测试两种存储后端
cargo run --release --bin benchmark -- -H test/hot -C test/cold

# 只测试 Tokio 后端
cargo run --release --bin benchmark -- -H test/hot -C test/cold --mode tokio

# 自定义测试参数
cargo run --release --bin benchmark -- \
  -H test/hot \
  -C test/cold \
  -n 100 \                    # 测试文件数量
  --small-size 1024 \         # 小文件大小（字节）
  --large-size 10485760 \     # 大文件大小（字节）
  -t 1048576                  # 阈值（字节）
```

### 运行文件迁移工具
```bash
# 迁移单个文件
cargo run --bin migrate -- -H test/hot -C test/cold -t 1048576 -p path/to/file

# 扫描并迁移整个存储
cargo run --bin migrate -- -H test/hot -C test/cold -t 1048576 -a
```

## 性能测试结果示例

从基准测试可以看出：
- **Rustix 在读取操作上更快**：小文件读取快 60.8%，大文件读取快 56.3%
- **Tokio 在写入操作上更快**：小文件写入快 27.9%，大文件写入快 47.9%
- 两种后端各有优势，可根据实际使用场景选择